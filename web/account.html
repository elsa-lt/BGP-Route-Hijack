<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">

	<meta http-equiv="PRAGMA" content="NO-CACHE">
	<meta http-equiv="Cache-Control" content="no-cache, no-control, must-revalidate">
	<meta http-equiv="expires" content="0">

	<meta name="Copyright" content="(c) Copyright  2004 DBS Bank">
	<meta name="viewport" content="width=device-width, initial-scale=1,  user-scalable=no">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="format-detection" content="telephone=no">
	<meta name="bwpageid" content="Login">

	<link rel="shortcut icon" href="./DBS_iBanking_files/dbs_logo_min1.png">

	<title>DBS iBanking</title>
	<link rel="stylesheet" href="./DBS_iBanking_files/themes_login.css">
	<link rel="stylesheet" href="./DBS_iBanking_files/language_login.css">

	<link rel="stylesheet" href="./DBS_iBanking_files/login.css">
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const username = localStorage.getItem('username');
            const password = localStorage.getItem('password');

            // Redirect to login page if no username or password is stored
            if (!username || !password) {
                alert('User not logged in. Redirecting to login page...');
                window.location.href = 'login.html';
            }

            // Basic Authentication
            const headers = new Headers();
	    headers.append('Content-Type', 'application/json');
            headers.append('Authorization', 'Basic ' + btoa(username + ':' + password));

            // Example of using the stored information for a request
            fetch('http://192.168.225.128:80/account/secret', {
                method: 'GET',
                headers: headers
            })
            .then(response => {
                if (!response.ok) {
		    // Print the status code and status text for more details
		    console.error(`Error ${response.status}: ${response.statusText}`);
                    throw new Error('Failed to fetch secret word');
                }
                return response.json();
            })
            .then(data => {
		console.log("DATA: ", data);
                const secretWord = data.secret_word || 'No secret word currently';
		console.log(secretWord);
		document.getElementById('secret_word').textContent = secretWord;

            })
            .catch(error => {
                console.error('Error fetching secret word:', error);
                document.getElementById('secret_word').textContent = 'Failed to load secret word';
            });
        });
        async function logout(event) {
            event.preventDefault(); // Prevent the form from submitting the traditional way
            localStorage.removeItem('username'); // Clear stored username
            localStorage.removeItem('token');    // Clear stored token
            window.location.href = 'login.html'; // Redirect to login page
        }
        function saveSecretWord() {
	    const secretWord = document.getElementById('newSecretWord').value;
            const username = localStorage.getItem('username');
            const password = localStorage.getItem('password');
            
            // Redirect to login page if no username or password is stored
            if (!username || !password) {
                alert('User not logged in. Redirecting to login page...');
                window.location.href = 'login.html';
            }

	    // Basic Authentication
            const headers = new Headers();
            headers.append('Content-Type', 'application/json');
	    headers.append('Authorization', 'Basic ' + btoa(username + ':' + password));

            fetch('http://192.168.225.128:80/account/secret', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ secret_word: secretWord })
            })
            .then(response => {
                if (!response.ok) {
                    // Print the status code and status text for more details
                    console.error(`Error ${response.status}: ${response.statusText}`);
                    throw new Error('Failed to save secret word');
                }
                return response.json();
            })
            .then(data => {
                console.log(data.message);
                if (data.message === "Secret word saved successfully.") {
                    // Show an alert for successful saving of the secret word
                    alert('Secret word saved successfully!');
                    
                    window.location.reload()
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</head>
<body>

	<iframe src="./DBS_iBanking_files/iframe.html" id="iframe1" name="iframe1" scrolling="no" frameborder="0"
		class="content-holder" style="height: 639px;">
	</iframe>

    <div class="login-form">
        <div class="text-center logo">
            <img src="./DBS_iBanking_files/desktoplogo.png" alt="DBS Logo">
        </div>

        <h1 style="margin: 10px 0px;">Welcome to Your Account</h1>

        <!-- Current secret word display -->
        <div class="form-row input-layout">
            <label for="secret_word">Current Secret Word:</label>
            <br>
            <p id="secret_word">Loading...</p>
        </div>
        <br>

        <!-- Secret word input -->
        <div class="form-row input-layout">
            <input type="text" name="newSecretWord" id="newSecretWord" placeholder="Set a Secret Word" maxlength="20" class="left" autocomplete="off">
        </div>

        <!-- Submit button -->
        <div class="mTop-38">
            <button class="btn btn-primary block mBot-12" onclick="saveSecretWord()" type="button">Submit Secret Word</button>
        </div>

        <!-- Logout button -->
        <div class="mTop-38">
            <button class="btn btn-secondary block mBot-12" onclick="logout(event)" type="button">Logout</button>
        </div>
    </div>
</body>
</html>
